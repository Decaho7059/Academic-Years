/******************************************************************************

Welcome to GDB Online.
  GDB online is an online compiler and debugger tool for C, C++, Python, PHP, Ruby, 
  C#, OCaml, VB, Perl, Swift, Prolog, Javascript, Pascal, COBOL, HTML, CSS, JS
  Code, Compile, Run and Debug online from anywhere in world.

*******************************************************************************/
#include <stdio.h>
#include <sys/select.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

//void creerEnfantEtLire(int );

// int main (int ac, char**av)
// {
//   int numeroProcessus;

//   if (ac == 2)
//     {
//       if (sscanf (av[1], "%d", &numeroProcessus) == 1)
// 	{
// 	  creerEnfantEtLire (numeroProcessus);
// 	}
//      else{
// 	fprintf (stderr, "Ne peut pas traduire argument\n");
//     }
    
//     }
//   else{
//     fprintf (stderr, "Arguments pas valide\n");
//   return (0);}
// }


creerEnfantEtLire (int prcNum)
{
  int num = 0;
  printf ("Processus %d commence\n", prcNum);
  fflush (stdout);
  if (prcNum > 1)
    {
      int fd[2];		//0 -> read, 1 -> write
      pipe (fd);
      int pid = fork();
      if (pid == -1)
	{
	  perror ("fork() non-reussi.\n");
	  //exit (1);
	}
      if (pid == 0)
	{
//child
	  close (fd[0]);
// Termeture de l'entree au tuvau - non
	  dup2 (fd[1], 1);	//remplacement de la sortie standard avec la
	  char prcNum_str[32];
	  sprintf (prcNum_str, "'%d", prcNum - 1);
	  char *args[] =
	  {
	  "cpr", prcNum_str, NULL};

	  execvp (args[0], args);
	}
      else
	{			//parent
	  close (fd[1]);
	  fflush (stdout);
	  char readbuf[512];
	  while ((num = read (fd[0], readbuf, 512)) > 0)
	    {
	      write (1, readbuf, num);
	    }
//wait (NULL);}
	}
//arret
      if (prcNum == 1)
	{
	  sleep (5);
	}
      printf ("Processus %d termine\n", prcNum);
//sleep (10);
      fflush (stdout);
      close (1);
    }
}
int main (int ac, char**av)
{
  int numeroProcessus;

  if (ac == 2)
    {
      if (sscanf (av[1], "%d", &numeroProcessus) == 1)
	{
	  creerEnfantEtLire (numeroProcessus);
	}
     else{
	fprintf (stderr, "Ne peut pas traduire argument\n");
    }
    
    }
  else{
    fprintf (stderr, "Arguments pas valide\n");
  return (0);}
}
//void creerEnfantEtLire(5);